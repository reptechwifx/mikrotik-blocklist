stages: [build]

image: docker:27.3.1

variables:
  DOCKER_BUILDKIT: "1"
  BUILDKIT_INLINE_CACHE: "1"
  IMAGE_PATH: "$CI_REGISTRY_IMAGE"        
  CONTEXT: "blocklist"                        # dossier qui contient le Dockerfile (adapter si besoin)

before_script:
  # Nécessite que le runner expose /var/run/docker.sock (pas de service DinD requis)
  - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"

build-image:
  stage: build
  script:
    # Build + push tag immuable (git-<sha-court>) pour chaque commit
    - TAG_COMMIT="git-$CI_COMMIT_SHORT_SHA"
    - docker build -f "$CONTEXT/Dockerfile" -t "$IMAGE_PATH:$TAG_COMMIT" "$CONTEXT"
    - docker push "$IMAGE_PATH:$TAG_COMMIT"

    # Si on est sur main, créer aussi :main et :latest
    - |
      if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        docker tag  "$IMAGE_PATH:$TAG_COMMIT" "$IMAGE_PATH:main"
        docker tag  "$IMAGE_PATH:$TAG_COMMIT" "$IMAGE_PATH:latest"
        docker push "$IMAGE_PATH:main"
        docker push "$IMAGE_PATH:latest"
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
