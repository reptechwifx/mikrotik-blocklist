<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>WIFX Mikrotik Blocklist</title>
  <style>
    body { margin:0; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; background:#f5f6f8; }
    header { background:#0747a6; color:#fff; padding:8px 16px; display:flex; align-items:center; }
    header img { height:28px; margin-right:12px; }
    header .title { font-size:18px; font-weight:600; }
    main { max-width:900px; margin:24px auto; background:#fff; padding:24px 28px; border-radius:6px; box-shadow:0 1px 3px rgba(9,30,66,0.13); }
    h1 { margin-top:0; font-size:22px; color:#172b4d; }
    h2 { color:#172b4d; }
    h3 { color:#172b4d; }
    p { color:#42526e; }
    ul { padding-left:20px; }
    li { margin:4px 0; }
    code { background:#f4f5f7; padding:2px 4px; border-radius:3px; font-size:90%; }
    pre code { display:block; padding:12px; white-space:pre; overflow-x:auto; }
    footer { text-align:center; padding:16px; font-size:12px; color:#6b778c; }
    footer a { color:#0747a6; text-decoration:none; }

    .builder { margin-top:24px; padding:16px; border-radius:6px; background:#f4f5f7; }
    .builder-form label { display:block; margin-bottom:8px; }
    .builder-form input[type="text"],
    .builder-form textarea { width:100%; box-sizing:border-box; }
    .builder-sources ul { list-style-type:none; padding-left:0; }
    .builder-sources li { margin-bottom:6px; }
    .builder-sources label { font-weight:500; color:#172b4d; }
    .builder-actions { margin-top:12px; }
    .builder-actions button,
    .builder-output button { padding:6px 12px; border-radius:4px; border:0; cursor:pointer; background:#0747a6; color:#fff; font-size:13px; }
    .builder-output { margin-top:12px; }
    .builder-output input { margin-bottom:8px; }

    .note { font-size:12px; color:#6b778c; }
  </style>
</head>
<body>
<header>
  <img src="/html/logo.png" alt="WIFX">
  <div class="title">WIFX MikroTik Blocklist Service</div>
</header>
<main>
  <h1>MikroTik Blocklists</h1>
  <p>
    Internal WIFX service that compiles and aggregates multiple blocklist sources
    into <code>.rsc</code> files ready to be imported into RouterOS.
  </p>

  <!-- List + builder will be injected here -->
  {{SOURCES}}

  <h2>Quick usage (MikroTik Ros7)</h2>
  <p class="note">
    By default this fetches the global list <code>all.rsc</code>. If you generate a custom URL above,
    the script below will automatically update the <code>fetch</code> URL and the
    <code>src-address-list</code> so you can copy/paste it.
  </p>
  <pre><code id="mikrotik-script">/system script
add dont-require-permissions=yes name=blocklist policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon source=\
    "# name of RAM disk\r\
    \n:local ramdisk \"tmpfs1\";\r\
    \n\r\
    \n# Check if RAM disk exists\r\
    \n:if ([:len [/disk find slot=\$ramdisk]] = 0) do={\r\
    \n    :log warning \"RAM disk &lt;\$ramdisk&gt; missing - created...\";\r\
    \n    /disk add type=tmpfs tmpfs-max-size=10M slot=\$ramdisk;\r\
    \n    :delay 1s;\r\
    \n} else={\r\
    \n    :log info \"RAM disk &lt;\$ramdisk&gt; already created\";\r\
    \n}\r\
    \n\r\
    \n# Download .rsc into RAM disk\r\
    \n/tool fetch url=\"__BLOCKLIST_DEFAULT_URL__\" dst-path=\"\$ramdisk/blocklist.rsc\";\r\
    \n:delay 10\r\
    \n# Import file\r\
    \n/import file-name=\"\$ramdisk/blocklist.rsc\";"

/system scheduler
add interval=1h30m name=blocklist on-event=blocklist policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon start-time=startup

/ip firewall raw
add action=drop chain=prerouting src-address-list=blacklist
</code></pre>

</main>
<footer>
  WIFX SA -
  <a href="https://www.wifx.net" target="_blank" rel="noopener">www.wifx.net</a>
  <span style="color:#6b778c;">&nbsp;|&nbsp; Generated by ChatGPT ü§ñ‚ú®</span>
</footer>
<script>
(function() {
  const PLACEHOLDER_URL = "__BLOCKLIST_DEFAULT_URL__";

  function getOrigin() {
    try {
      return window.location.origin;
    } catch (e) {
      return "";
    }
  }

  function getDefaultUrl() {
    const origin = getOrigin();
    if (!origin) return "/all.rsc";
    return origin + "/all.rsc";
  }

  function buildCustomUrl() {
    const origin = getOrigin();
    const listInput = document.getElementById("list-name");
    const timeoutInput = document.getElementById("timeout");
    const wlTextarea = document.getElementById("whitelist");
    const urlOutput = document.getElementById("generated-url");

    if (!urlOutput) return null;
    if (!origin) {
      alert("Unable to detect page origin.");
      return null;
    }

    const listName = (listInput && listInput.value.trim()) || "";
    const timeout = (timeoutInput && timeoutInput.value.trim()) || "";
    const wlRaw = (wlTextarea && wlTextarea.value) || "";

    const params = [];

    if (listName && listName !== "blacklist") {
      params.push("list=" + encodeURIComponent(listName));
    }
    if (timeout && timeout !== "06:00:00") {
      params.push("timeout=" + encodeURIComponent(timeout));
    }

    const checks = document.querySelectorAll(".src-checkbox:checked");
    if (!checks.length) {
      alert("Please select at least one source.");
      return null;
    }
    checks.forEach(function(cb) {
      params.push("src=" + encodeURIComponent(cb.value));
    });

    if (wlRaw) {
      wlRaw.split(/\r?\n/).forEach(function(line) {
        const trimmed = line.trim();
        if (trimmed) {
          params.push("wl=" + encodeURIComponent(trimmed));
        }
      });
    }

    let url = origin + "/custom.rsc";
    if (params.length) {
      url += "?" + params.join("&");
    }

    urlOutput.value = url;
    return url;
  }

  function setupBuilder() {
    const generateBtn = document.getElementById("generate-btn");
    const copyBtn = document.getElementById("copy-url");
    const urlOutput = document.getElementById("generated-url");
    const scriptCode = document.getElementById("mikrotik-script");
    const listInput = document.getElementById("list-name");

    if (!scriptCode) return;

    // Script de base pr√©sent dans le HTML
    const originalScript = scriptCode.textContent;

    function currentListName() {
      const v = listInput && listInput.value.trim();
      return v || "blacklist";
    }

    function applyScriptTemplate(url, listName) {
      let updated = originalScript;

      // Injecte l'URL r√©elle √† la place du placeholder
      if (url) {
        updated = updated.replace(PLACEHOLDER_URL, url);
      }

      // Met √† jour automatiquement src-address-list=<list-name>
      updated = updated.replace(/src-address-list=[A-Za-z0-9_\-]+/g,
        "src-address-list=" + listName
      );

      scriptCode.textContent = updated;
    }

    // Initialisation du script avec l'URL par d√©faut (bas√©e sur l'origin)
    const defaultUrl = getDefaultUrl();
    applyScriptTemplate(defaultUrl, "blacklist");

    if (!generateBtn || !copyBtn || !urlOutput) return;

    generateBtn.addEventListener("click", function() {
      const url = buildCustomUrl();
      if (url) {
        applyScriptTemplate(url, currentListName());
      }
    });

    copyBtn.addEventListener("click", function() {
      if (!urlOutput.value) return;
      urlOutput.select();
      urlOutput.setSelectionRange(0, 99999);
      try {
        document.execCommand("copy");
      } catch (e) {
        // ignore
      }
    });
  }

  document.addEventListener("DOMContentLoaded", setupBuilder);
})();
</script>
</body>
</html>
